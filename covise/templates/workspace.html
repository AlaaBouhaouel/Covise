{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoVise | Workspace</title>
    <link rel="icon" href="{% static 'images/index/noBgLogo.png' %}" type="image/png">
    <link rel="stylesheet" href="{% static 'workspace.css' %}">
    <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700&family=Darker+Grotesque:wght@300;400;500;600&display=swap" rel="stylesheet">
</head>
<body>
    <div class="layout">
        <aside class="sidebar" aria-label="Primary">
            <a class="sidebar-link" href="{% url 'Home' %}" aria-label="Home">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8">
                    <path d="M3 10.5L12 3l9 7.5"></path>
                    <path d="M5 10.5V21h14V10.5"></path>
                </svg>
            </a>
            <a class="sidebar-link" href="{% url 'Projects' %}" aria-label="Projects">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8">
                    <rect x="3" y="4" width="7" height="7"></rect>
                    <rect x="14" y="4" width="7" height="7"></rect>
                    <rect x="3" y="15" width="7" height="7"></rect>
                    <rect x="14" y="15" width="7" height="7"></rect>
                </svg>
            </a>
            <a class="sidebar-link" href="{% url 'Messages' %}" aria-label="Messages">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8">
                    <path d="M4 6h16v10H7l-3 3V6z"></path>
                </svg>
            </a>
            <a class="sidebar-link" id="side_active" href="{% url 'Workspace' %}" aria-label="Workspace">
                <img src="{% static 'images/index/noBgLogo.png' %}" alt="Covise logo">
            </a>
            <a class="sidebar-link" href="{% url 'Profile' %}" aria-label="Profile">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8">
                    <circle cx="12" cy="8" r="4"></circle>
                    <path d="M4 21c1.8-4 5-6 8-6s6.2 2 8 6"></path>
                </svg>
            </a>
            <a class="sidebar-link" href="{% url 'Settings' %}" aria-label="Settings">
                <svg viewBox="0 0 24 24" fill="none" stroke-width="1.8">
                    <circle cx="12" cy="12" r="3"></circle>
                    <path d="M12 15C13.6569 15 15 13.6569 15 12C15 10.3431 13.6569 9 12 9C10.3431 9 9 10.3431 9 12C9 13.6569 10.3431 15 12 15Z" stroke="currentColor" stroke-width="2"/>
                </svg>
            </a>
        </aside>

        <main class="main">
            <header class="workspace-header">
                <div>
                    <h1>Workspace Canvas</h1>
                    <p>Add elements, drag them, and edit content directly on the canvas.</p>
                </div>
                <a class="back-link" href="{% url 'Home' %}">Back to Home</a>
            </header>

            <section class="workspace-shell">
                <aside class="toolbox">
                    <h2>Tools</h2>
                    <button type="button" class="tool-btn" data-create="text">Add Text</button>
                    <button type="button" class="tool-btn" data-create="note">Add Note</button>
                    <button type="button" class="tool-btn" data-create="card">Add Card</button>
                    <button type="button" class="tool-btn danger" id="removeSelected">Delete Selected</button>
                    <button type="button" class="tool-btn danger" id="clearCanvas">Clear Canvas</button>
                    <p class="tool-help">Tip: click an item to select, then drag to move. Double click to edit text.</p>
                </aside>

                <div class="canvas-wrap">
                    <div class="canvas" id="freeCanvas" aria-label="Free workspace canvas"></div>
                </div>
            </section>
        </main>
    </div>

    <script>
        const canvas = document.getElementById('freeCanvas');
        const removeBtn = document.getElementById('removeSelected');
        const clearBtn = document.getElementById('clearCanvas');
        let selected = null;
        let dragState = null;
        let nextId = 1;

        function clamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }

        function setSelected(el) {
            if (selected) {
                selected.classList.remove('is-selected');
            }
            selected = el;
            if (selected) {
                selected.classList.add('is-selected');
            }
        }

        function createItem(type) {
            const item = document.createElement('div');
            item.className = `canvas-item type-${type}`;
            item.dataset.id = `item-${nextId++}`;
            item.contentEditable = 'true';
            item.spellcheck = true;

            if (type === 'text') {
                item.textContent = 'Edit text';
            } else if (type === 'note') {
                item.textContent = 'Quick note';
            } else {
                item.innerHTML = '<strong>Card title</strong><br>Describe this block';
            }

            item.style.left = '32px';
            item.style.top = '32px';

            item.addEventListener('mousedown', (event) => {
                setSelected(item);
                if (event.target !== item || item.isContentEditable && document.activeElement === item) {
                    return;
                }

                const canvasRect = canvas.getBoundingClientRect();
                const itemRect = item.getBoundingClientRect();
                dragState = {
                    item,
                    offsetX: event.clientX - itemRect.left,
                    offsetY: event.clientY - itemRect.top,
                    canvasRect
                };
                item.classList.add('is-dragging');
                event.preventDefault();
            });

            item.addEventListener('click', (event) => {
                event.stopPropagation();
                setSelected(item);
            });

            canvas.appendChild(item);
            setSelected(item);
            item.focus();
        }

        document.querySelectorAll('[data-create]').forEach((btn) => {
            btn.addEventListener('click', () => createItem(btn.dataset.create));
        });

        removeBtn.addEventListener('click', () => {
            if (!selected) return;
            selected.remove();
            selected = null;
        });

        clearBtn.addEventListener('click', () => {
            canvas.innerHTML = '';
            selected = null;
        });

        canvas.addEventListener('click', () => setSelected(null));

        document.addEventListener('mousemove', (event) => {
            if (!dragState) return;
            const { item, offsetX, offsetY, canvasRect } = dragState;
            const maxX = canvas.clientWidth - item.offsetWidth;
            const maxY = canvas.clientHeight - item.offsetHeight;
            const x = clamp(event.clientX - canvasRect.left - offsetX, 0, Math.max(0, maxX));
            const y = clamp(event.clientY - canvasRect.top - offsetY, 0, Math.max(0, maxY));
            item.style.left = `${x}px`;
            item.style.top = `${y}px`;
        });

        document.addEventListener('mouseup', () => {
            if (!dragState) return;
            dragState.item.classList.remove('is-dragging');
            dragState = null;
        });
    </script>
</body>
</html>
